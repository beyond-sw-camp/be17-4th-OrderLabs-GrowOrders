pipeline {
  agent {
    kubernetes {
      label "node-kaniko-${UUID.randomUUID().toString()}"
      defaultContainer 'node'
      yaml """
apiVersion: v1
kind: Pod
spec:
  restartPolicy: Never
  containers:
    - name: node
      image: node:22.17.1-bullseye
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace
          mountPath: /workspace
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ['/busybox/sh','-c','sleep infinity']
      tty: true
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
        - name: workspace
          mountPath: /workspace
  volumes:
    - name: workspace
      emptyDir: {}
    - name: docker-config
      secret:
        secretName: dockerhub-cred
        items:
          - key: .dockerconfigjson
            path: config.json
"""
    }
  }

  environment {
    IMAGE_NAME   = 'hanwhabootcamp17/orderlabs-frontend'
    IMAGE_TAG    = "${env.BUILD_NUMBER}"
    NAMESPACE    = "orderlabs"
    SERVICE_NAME = "orderlabs-frontend"
  }

  stages {
    stage('Checkout') {
      steps {
        container('node') {
          checkout([$class: 'GitSCM',
            branches: [[name: '*/main']],
            userRemoteConfigs: [[url: 'https://github.com/atimaby28/OrdersLabCICD_Front']]
          ])
        }
      }
    }

    stage('NPM Build') {
      steps {
        container('node') {
          sh '''
            npm install
            npm run build
            ls -lh dist/
          '''
        }
      }
    }

    stage('Kaniko Build & Push') {
      steps {
        container('kaniko') {
          sh """
            /kaniko/executor \
              --context=${WORKSPACE} \
              --dockerfile=${WORKSPACE}/Dockerfile \
              --destination=${IMAGE_NAME}:${IMAGE_TAG} \
              --single-snapshot \
              --use-new-run \
              --cache=true \
              --snapshotMode=redo
          """
        }
      }
    }

    stage('Canary Deploy') {
      steps {
        script {
          sshPublisher(
            publishers: [
              sshPublisherDesc(
                configName: 'k8s_server',
                verbose: true,
                transfers: [
                  sshTransfer(
                    sourceFiles: 'k8s/frontend-deployment.yml',
                    remoteDirectory: '/home/test/k8s',
                    execCommand: """
                      echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ Canary ë°°í¬ ì‹œì‘"

                      # ìƒˆ ë²„ì „ Canary ë°°í¬
                      kubectl set image deployment/${SERVICE_NAME}-canary frontend=${IMAGE_NAME}:${IMAGE_TAG} -n ${NAMESPACE}
                      kubectl scale deployment/${SERVICE_NAME}-canary --replicas=1 -n ${NAMESPACE}
                      kubectl rollout status deployment/${SERVICE_NAME}-canary -n ${NAMESPACE}

                      echo "ğŸ“Œ Canary íŠ¸ë˜í”½ ë¹„ìœ¨ ì ì§„ì  ì¦ê°€"

                      # Step 1: Canary 20%
                      kubectl annotate ingress ${SERVICE_NAME}-canary-ingress \
                        -n ${NAMESPACE} \
                        nginx.ingress.kubernetes.io/canary-weight="20" \
                        --overwrite
                      sleep 30   # ê²€ì¦ ëŒ€ê¸°

                      # Step 2: Canary 50%
                      kubectl annotate ingress ${SERVICE_NAME}-canary-ingress \
                        -n ${NAMESPACE} \
                        nginx.ingress.kubernetes.io/canary-weight="50" \
                        --overwrite
                      sleep 30   # ê²€ì¦ ëŒ€ê¸°

                      # Step 3: Canary 100%
                      kubectl annotate ingress ${SERVICE_NAME}-canary-ingress \
                        -n ${NAMESPACE} \
                        nginx.ingress.kubernetes.io/canary-weight="100" \
                        --overwrite

                      echo "âœ… Canary ë°°í¬ ì™„ë£Œ (100% íŠ¸ë˜í”½ Canaryë¡œ ì´ë™)"
                    """
                  )
                ]
              )
            ]
          )
        }
      }
    }

    stage('Approval for Stable Promotion') {
      steps {
        script {
          def userInput = input(
            id: 'Proceed',
            message: 'Canary ê²€ì¦ ì™„ë£Œí–ˆë‚˜ìš”? Stableë¡œ ìŠ¹ê²©í• ê¹Œìš”?',
            parameters: [
              [$class: 'ChoiceParameterDefinition',
               choices: ['Yes', 'No'],
               description: 'ìŠ¹ê²© ì—¬ë¶€ ì„ íƒ',
               name: 'Proceed']
            ]
          )

          if (userInput == 'Yes') {
            echo "ğŸ‘ ìš´ì˜ì ìŠ¹ì¸ ì™„ë£Œ â†’ Stable ìŠ¹ê²© ë‹¨ê³„ë¡œ ì§„í–‰"
          } else {
            error "ğŸš« ìŠ¹ê²© ê±°ë¶€ë¨ â†’ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨"
          }
        }
      }
    }

    stage('Promote to Stable') {
      steps {
        script {
          sshPublisher(
            publishers: [
              sshPublisherDesc(
                configName: 'k8s_server',
                verbose: true,
                transfers: [
                  sshTransfer(
                    execCommand: """
                      echo "ğŸš€ Stable ìŠ¹ê²© ì‹œì‘"

                      # Stable Deploymentë¥¼ ìµœì‹  ì´ë¯¸ì§€ë¡œ êµì²´
                      kubectl set image deployment/${SERVICE_NAME}-stable frontend=${IMAGE_NAME}:${IMAGE_TAG} -n ${NAMESPACE}
                      kubectl rollout status deployment/${SERVICE_NAME}-stable -n ${NAMESPACE}

                      echo "ğŸ§¹ Canary ë¦¬ì†ŒìŠ¤ ì •ë¦¬"
                      kubectl delete ingress ${SERVICE_NAME}-canary-ingress -n ${NAMESPACE} --ignore-not-found
                      kubectl delete deployment ${SERVICE_NAME}-canary -n ${NAMESPACE} --ignore-not-found
                      kubectl delete service ${SERVICE_NAME}-canary -n ${NAMESPACE} --ignore-not-found

                      echo "âœ… Stable ìŠ¹ê²© ì™„ë£Œ: ëª¨ë“  íŠ¸ë˜í”½ v${IMAGE_TAG}"
                    """
                  )
                ]
              )
            ]
          )
        }
      }
    }

    stage('Result') {
      steps {
        echo "ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ: ${IMAGE_NAME}:${IMAGE_TAG}"
      }
    }
  }

  post {
    success {
      container('gradle') {
          sh """
              curl -H "Content-Type: application/json" \
                    -X POST \
                    -d '{"content":"í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì„±ê³µ: ${env.BUILD_NUMBER}"}' \
                    https://discordapp.com/api/webhooks/1419497844427198534/cGqansTO4Bc_XnuJfNpn1Yt4lpFDT0uB89_kFEr8uJbNP3kSKKrjorCniBQovbMMyl9a
          """
      }
    }
    failure {
      container('gradle') {
          sh """
              curl -H "Content-Type: application/json" \
                    -X POST \
                    -d '{"content":"í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨: ${env.BUILD_NUMBER}"}' \
                    https://discordapp.com/api/webhooks/1419497844427198534/cGqansTO4Bc_XnuJfNpn1Yt4lpFDT0uB89_kFEr8uJbNP3kSKKrjorCniBQovbMMyl9a
          """
      }
    }
  }
}